# 测试订单上传到聚水潭脚本

## 快速测试步骤

### 1. 准备工作

#### 1.1 检查聚水潭配置
```sql
-- 查看聚水潭配置是否正确
SELECT * FROM eb_system_config WHERE name IN ('jushuitan_apikey', 'jushuitan_secret');
```

#### 1.2 查询待上传订单
```sql
-- 查看有多少订单需要上传
SELECT 
    COUNT(*) as total_count,
    SUM(CASE WHEN paid = 1 THEN 1 ELSE 0 END) as paid_count,
    SUM(CASE WHEN jst_order_id IS NULL THEN 1 ELSE 0 END) as need_upload_count
FROM eb_order
WHERE is_del = 0;

-- 查看具体的待上传订单
SELECT 
    order_no,
    mer_id,
    uid,
    pay_price,
    status,
    paid,
    jst_order_id,
    create_time
FROM eb_order
WHERE jst_order_id IS NULL
  AND paid = 1
  AND is_del = 0
  AND status IN (1, 2, 3, 4, 5)
ORDER BY create_time ASC
LIMIT 10;
```

### 2. 测试方式

#### 方式一：手动触发定时任务（推荐）

在任意 Controller 中添加测试接口：

```java
@RestController
@RequestMapping("/test")
public class TestController {
    
    @Autowired
    private JustuitanOrderSyncTask justuitanOrderSyncTask;
    
    /**
     * 手动触发订单上传
     * 访问: http://localhost:8080/test/upload-orders
     */
    @GetMapping("/upload-orders")
    public CommonResult testUploadOrders() {
        try {
            justuitanOrderSyncTask.uploadLocalOrdersToJst();
            return CommonResult.success("订单上传任务执行完成，请查看日志");
        } catch (Exception e) {
            return CommonResult.failed("订单上传任务执行失败: " + e.getMessage());
        }
    }
}
```

#### 方式二：单个订单测试

```java
@Autowired
private JustuitanErpService justuitanErpService;

@Autowired
private OrderService orderService;

/**
 * 测试上传单个订单
 * 访问: http://localhost:8080/test/upload-order?orderNo=订单号
 */
@GetMapping("/upload-order")
public CommonResult testUploadOrder(@RequestParam String orderNo) {
    try {
        Order order = orderService.getByOrderNo(orderNo);
        if (order == null) {
            return CommonResult.failed("订单不存在");
        }
        
        JustuitanOrderUploadResult result = justuitanErpService.uploadOrderToJst(order);
        
        if (result.isSuccess()) {
            return CommonResult.success(result, "订单上传成功");
        } else {
            return CommonResult.failed("订单上传失败: " + result.getMessage());
        }
    } catch (Exception e) {
        return CommonResult.failed("订单上传异常: " + e.getMessage());
    }
}
```

#### 方式三：启用定时任务自动执行

确保 `@Scheduled` 注解未被注释：

```java
@Scheduled(fixedRate = 900000) // 15分钟
public void uploadLocalOrdersToJst() {
    // ...
}
```

### 3. 验证结果

#### 3.1 查看日志
查看日志文件，确认上传结果：
```bash
tail -f jcly_shop_log/log_info.log | grep "订单上传"
```

#### 3.2 查询数据库
```sql
-- 查看已上传的订单
SELECT 
    order_no,
    jst_order_id,
    status,
    pay_price,
    create_time,
    update_time
FROM eb_order
WHERE jst_order_id IS NOT NULL
ORDER BY update_time DESC
LIMIT 10;

-- 统计上传情况
SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN jst_order_id IS NOT NULL THEN 1 ELSE 0 END) as uploaded,
    SUM(CASE WHEN jst_order_id IS NULL THEN 1 ELSE 0 END) as not_uploaded
FROM eb_order
WHERE paid = 1 AND is_del = 0;
```

#### 3.3 登录聚水潭后台
1. 登录聚水潭ERP后台
2. 进入"订单管理"
3. 搜索对应的订单号（`so_id` 对应本地的 `order_no`）
4. 确认订单数据是否正确

### 4. 常见问题排查

#### 问题1: 提示缺少 sku_id
**原因**: 订单商品没有聚水潭SKU ID

**解决**:
```sql
-- 查看订单商品是否有聚水潭映射
SELECT 
    od.order_no,
    od.product_id,
    od.attr_value_id,
    p.name as product_name,
    p.jst_item_id,
    pav.jst_sku_id
FROM eb_order_detail od
LEFT JOIN eb_product p ON od.product_id = p.id
LEFT JOIN eb_product_attr_value pav ON od.attr_value_id = pav.id
WHERE od.order_no = '订单号';

-- 如果商品没有 jst_item_id 或 jst_sku_id，需要先上传商品
```

**修复方案**:
1. 先上传商品到聚水潭
2. 保存商品和SKU的聚水潭ID
3. 然后再上传订单

#### 问题2: 订单被跳过（非自营店）
**原因**: 订单所属商户不是自营店

**解决**:
```sql
-- 查看商户是否为自营店
SELECT 
    o.order_no,
    o.mer_id,
    m.name as merchant_name,
    m.is_self
FROM eb_order o
LEFT JOIN eb_merchant m ON o.mer_id = m.id
WHERE o.order_no = '订单号';

-- 如果需要上传所有订单，可以临时注释掉自营店判断代码
```

#### 问题3: 收货地址缺失
**原因**: 订单没有关联收货地址

**解决**:
```sql
-- 查看用户地址
SELECT 
    o.order_no,
    o.uid,
    ua.real_name,
    ua.phone,
    ua.province,
    ua.city,
    ua.district,
    ua.detail
FROM eb_order o
LEFT JOIN eb_user_address ua ON o.uid = ua.uid AND ua.is_default = 1
WHERE o.order_no = '订单号';
```

### 5. 调试建议

#### 5.1 降低日志级别
在 `logback-spring.xml` 中设置：
```xml
<logger name="com.zbkj.service.service.impl.JustuitanErpServiceImpl" level="DEBUG"/>
<logger name="com.zbkj.service.task.JustuitanOrderSyncTask" level="DEBUG"/>
```

#### 5.2 查看完整请求和响应
在 `JustuitanErpServiceImpl.buildOrderUploadData` 方法中添加日志：
```java
logger.info("订单上传数据: {}", orderData.toJSONString());
```

#### 5.3 先测试一个订单
建议先测试上传一个订单，确认成功后再启用批量上传。

### 6. 性能测试

```sql
-- 统计待上传订单数量
SELECT COUNT(*) FROM eb_order 
WHERE jst_order_id IS NULL 
  AND paid = 1 
  AND is_del = 0 
  AND status IN (1, 2, 3, 4, 5);
```

**评估上传时间**:
- 单个订单上传耗时: ~1秒（包含500ms延迟）
- 100个订单预计耗时: ~100秒
- 1000个订单预计耗时: ~1000秒（约17分钟）

### 7. 生产环境建议

1. **先在测试环境验证**
   - 测试各种订单状态
   - 验证数据准确性
   - 确认无遗漏

2. **分批次上传历史订单**
   - 先上传最新的订单
   - 逐步上传历史订单
   - 避免一次性上传太多

3. **监控上传情况**
   - 关注日志中的成功/失败数量
   - 定期检查聚水潭后台
   - 及时处理失败订单

4. **设置告警**
   - 上传失败率超过10%时告警
   - 待上传订单数量持续增长时告警

### 8. 回滚方案

如果上传出现问题，可以清空已上传的订单ID：

```sql
-- ⚠️ 谨慎操作！清空聚水潭订单ID，使订单可以重新上传
UPDATE eb_order 
SET jst_order_id = NULL 
WHERE jst_order_id IS NOT NULL
  AND create_time >= '2025-01-01 00:00:00'; -- 只清空指定日期后的订单
```

### 9. 完整测试清单

- [ ] 聚水潭API配置正确
- [ ] 商品已上传到聚水潭并保存映射
- [ ] 订单有完整的收货地址
- [ ] 单个订单上传测试成功
- [ ] 批量上传测试成功
- [ ] 聚水潭后台确认订单数据正确
- [ ] 日志输出正常
- [ ] 异常处理测试完成
- [ ] 性能测试符合预期
- [ ] 生产环境部署计划确认

## 示例测试代码

### 完整测试Controller

```java
package com.zbkj.admin.controller.test;

import cn.hutool.core.collection.CollUtil;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.zbkj.common.model.order.Order;
import com.zbkj.common.response.CommonResult;
import com.zbkj.common.response.JustuitanOrderUploadResult;
import com.zbkj.service.service.JustuitanErpService;
import com.zbkj.service.service.OrderService;
import com.zbkj.service.task.JustuitanOrderSyncTask;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Slf4j
@RestController
@RequestMapping("/api/test/jushuitan")
@Api(tags = "测试 - 聚水潭订单上传")
public class JustuitanOrderTestController {

    @Autowired
    private JustuitanOrderSyncTask justuitanOrderSyncTask;

    @Autowired
    private JustuitanErpService justuitanErpService;

    @Autowired
    private OrderService orderService;

    @ApiOperation("查询待上传订单统计")
    @GetMapping("/pending-orders/stats")
    public CommonResult getPendingOrdersStats() {
        LambdaQueryWrapper<Order> queryWrapper = Wrappers.lambdaQuery();
        queryWrapper.isNull(Order::getJstOrderId);
        queryWrapper.eq(Order::getPaid, true);
        queryWrapper.eq(Order::getIsDel, false);
        queryWrapper.in(Order::getStatus, 1, 2, 3, 4, 5);

        List<Order> orders = orderService.selectList(queryWrapper);

        Map<String, Object> stats = new HashMap<>();
        stats.put("total", orders.size());
        stats.put("first10", orders.stream().limit(10).map(Order::getOrderNo).toArray());

        return CommonResult.success(stats);
    }

    @ApiOperation("手动触发批量上传")
    @PostMapping("/upload/batch")
    public CommonResult uploadBatch() {
        try {
            justuitanOrderSyncTask.uploadLocalOrdersToJst();
            return CommonResult.success("批量上传任务已触发，请查看日志");
        } catch (Exception e) {
            log.error("批量上传失败", e);
            return CommonResult.failed("批量上传失败: " + e.getMessage());
        }
    }

    @ApiOperation("上传单个订单")
    @PostMapping("/upload/single")
    public CommonResult uploadSingle(
            @ApiParam("订单号") @RequestParam String orderNo) {
        try {
            Order order = orderService.getByOrderNo(orderNo);
            if (order == null) {
                return CommonResult.failed("订单不存在: " + orderNo);
            }

            if (order.getJstOrderId() != null) {
                return CommonResult.failed("订单已上传到聚水潭，jst_order_id: " + order.getJstOrderId());
            }

            JustuitanOrderUploadResult result = justuitanErpService.uploadOrderToJst(order);

            if (result.isSuccess()) {
                Map<String, Object> data = new HashMap<>();
                data.put("orderNo", orderNo);
                data.put("jstOrderId", result.getJstOrderId());
                data.put("message", result.getMessage());
                return CommonResult.success(data, "订单上传成功");
            } else {
                return CommonResult.failed("订单上传失败: " + result.getMessage());
            }
        } catch (Exception e) {
            log.error("上传订单失败: {}", orderNo, e);
            return CommonResult.failed("上传订单异常: " + e.getMessage());
        }
    }

    @ApiOperation("清空订单的聚水潭ID（测试用）")
    @PostMapping("/reset/single")
    public CommonResult resetSingle(
            @ApiParam("订单号") @RequestParam String orderNo) {
        try {
            Order order = orderService.getByOrderNo(orderNo);
            if (order == null) {
                return CommonResult.failed("订单不存在: " + orderNo);
            }

            order.setJstOrderId(null);
            orderService.updateById(order);

            return CommonResult.success("订单聚水潭ID已清空，可重新上传");
        } catch (Exception e) {
            log.error("重置订单失败: {}", orderNo, e);
            return CommonResult.failed("重置订单失败: " + e.getMessage());
        }
    }
}
```

使用这个测试Controller，你可以通过Swagger或Postman进行测试。

