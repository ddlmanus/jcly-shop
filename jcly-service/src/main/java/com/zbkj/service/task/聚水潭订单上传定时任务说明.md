# 聚水潭订单上传定时任务说明

## 功能概述

自动将本地订单上传到聚水潭ERP系统，解决订单同步问题。

## 文件位置

```
jcly-service/src/main/java/com/zbkj/service/task/JustuitanOrderSyncTask.java
```

## 定时任务方法

### 1. `uploadLocalOrdersToJst()` - 上传本地订单到聚水潭

**执行频率**: 每15分钟执行一次

**任务功能**:
- 查询 `jst_order_id` 为空的已支付订单
- 自动上传到聚水潭ERP系统
- 记录上传结果（成功、失败、跳过数量）

**查询条件**:
- `jst_order_id` 为 `NULL`（未上传过的订单）
- `paid` = `true`（已支付）
- `is_del` = `false`（未删除）
- `status` IN (1, 2, 3, 4, 5)（待发货、部分发货、待核销、待收货、已完成）
- 每次最多处理 100 个订单
- 按创建时间升序排序（优先处理旧订单）

**特殊处理**:
- 只上传自营店的订单（通过 `isSelfOperatedStore()` 方法判断）
- 每个订单上传间隔 500 毫秒，避免频繁调用API
- 上传成功后会自动设置 `jst_order_id` 字段

## 启用/禁用定时任务

### 当前状态
定时任务**已启用**，系统启动后会自动执行。

### 禁用方法
如果需要禁用，注释掉 `@Scheduled` 注解：

```java
// @Scheduled(fixedRate = 900000) // 15分钟 = 900000毫秒
public void uploadLocalOrdersToJst() {
    // ...
}
```

### 修改执行频率
修改 `fixedRate` 参数（单位：毫秒）：

```java
@Scheduled(fixedRate = 600000)  // 10分钟 = 600000毫秒
@Scheduled(fixedRate = 1800000) // 30分钟 = 1800000毫秒
@Scheduled(fixedRate = 3600000) // 60分钟 = 3600000毫秒
```

## 日志输出

### 启动日志
```
==================== 开始执行本地订单上传到聚水潭定时任务 ====================
查询到 X 个待上传订单
```

### 处理日志
```
开始上传订单: orderNo=XXX, uid=XXX, payPrice=XXX, status=X
订单上传成功: orderNo=XXX, jstOrderId=XXX
```

### 完成日志
```
==================== 本地订单上传到聚水潭定时任务执行完成 ====================
总计处理: X 个订单, 成功: X, 失败: X, 跳过: X
```

## 错误处理

### 非自营店订单
```
订单不属于自营店，跳过上传: orderNo=XXX, merId=XXX
```

### 上传失败
```
订单上传失败: orderNo=XXX, 错误信息: XXX
```

### 异常情况
```
订单上传异常: orderNo=XXX
本地订单上传到聚水潭定时任务执行异常
```

## 前置条件

### 1. 聚水潭配置
确保系统配置了聚水潭ERP的认证信息：
- `jushuitan_apikey` - 聚水潭API Key
- `jushuitan_secret` - 聚水潭API Secret

### 2. 商品数据
订单中的商品需要先上传到聚水潭，并保存了映射关系：
- 商品表的 `jst_item_id` 字段（聚水潭商品ID）
- 规格表的 `jst_sku_id` 字段（聚水潭SKU ID）

### 3. 收货地址
订单必须有有效的收货地址信息。

## 手动触发

如果需要手动触发上传，可以：

1. 直接调用定时任务方法：
```java
@Autowired
private JustuitanOrderSyncTask justuitanOrderSyncTask;

// 手动触发
justuitanOrderSyncTask.uploadLocalOrdersToJst();
```

2. 或者直接调用服务方法上传单个订单：
```java
@Autowired
private JustuitanErpService justuitanErpService;

Order order = orderService.getByOrderNo("订单号");
JustuitanOrderUploadResult result = justuitanErpService.uploadOrderToJst(order);
```

## 监控建议

1. **定期检查日志**：查看上传成功率和失败原因
2. **监控待上传订单数量**：如果数量持续增长，可能需要调整执行频率
3. **关注聚水潭API限流**：如果遇到限流，需要调整批次大小或执行频率

## 性能优化

### 当前配置
- 每次最多处理 100 个订单
- 每个订单上传间隔 500 毫秒
- 每 15 分钟执行一次

### 调整建议
如果订单量很大，可以：
1. 增加批次大小（修改 `LIMIT` 值）
2. 减少订单间隔时间（修改 `Thread.sleep()` 值）
3. 增加执行频率（修改 `fixedRate` 值）

## 注意事项

1. **商品映射**：确保订单商品已上传到聚水潭，否则会因为缺少 `sku_id` 而上传失败
2. **自营店判断**：只上传自营店的订单，非自营店订单会被跳过
3. **API限流**：注意聚水潭API的调用频率限制
4. **重复上传**：已上传的订单（`jst_order_id` 不为空）不会重复上传
5. **订单状态**：只上传已支付的订单，待付款订单不会上传

## 相关接口

### JustuitanErpService
- `uploadOrderToJst(Order order)` - 上传单个订单到聚水潭
- `isSelfOperatedStore(Integer merId)` - 判断是否为自营店

### OrderService
- `selectList(LambdaQueryWrapper<Order> lambda)` - 查询订单列表

## 数据库字段

### Order 表
- `jst_order_id` VARCHAR - 聚水潭订单ID（上传成功后自动设置）
- `paid` TINYINT - 是否已支付
- `is_del` TINYINT - 是否删除
- `status` INT - 订单状态
- `mer_id` INT - 商户ID

## 故障排查

### 问题1：订单一直上传失败
**可能原因**：
- 商品未上传到聚水潭
- 缺少必填字段（如 `sku_id`）
- 聚水潭API认证失败

**解决方法**：
1. 检查商品的 `jst_item_id` 和 `jst_sku_id` 是否有值
2. 查看详细错误日志
3. 验证聚水潭API配置

### 问题2：订单被跳过
**可能原因**：
- 订单不属于自营店
- 订单状态不符合条件
- 订单未支付

**解决方法**：
1. 检查订单的 `mer_id` 对应的商户是否为自营店
2. 确认订单状态和支付状态

### 问题3：定时任务不执行
**可能原因**：
- `@Scheduled` 注解被注释
- Spring 定时任务未启用

**解决方法**：
1. 确认 `@Scheduled` 注解未被注释
2. 检查启动类是否有 `@EnableScheduling` 注解

## 版本历史

- **v1.0** (2025-01-17)
  - 初始版本
  - 支持自动上传 jst_order_id 为空的已支付订单
  - 支持自营店判断
  - 支持批量处理和错误重试

