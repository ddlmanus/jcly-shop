<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zbkj.service.dao.MerchantStoreStaffDao">

    <!-- 根据门店ID获取员工列表 -->
    <select id="getByStoreId" resultType="com.zbkj.common.model.merchant.MerchantStoreStaff">
        SELECT 
            staff.*,
            store.store_name as storeName
        FROM eb_merchant_store_staff staff
        LEFT JOIN eb_merchant_store store ON staff.store_id = store.id
        WHERE staff.store_id = #{storeId} 
        ORDER BY staff.is_manager DESC, staff.create_time DESC
    </select>

    <!-- 根据商户ID获取所有员工列表 -->
    <select id="getByMerId" resultType="com.zbkj.common.model.merchant.MerchantStoreStaff">
        SELECT 
            staff.*,
            store.store_name as storeName
        FROM eb_merchant_store_staff staff
        LEFT JOIN eb_merchant_store store ON staff.store_id = store.id
        WHERE store.mer_id = #{merId} 
        ORDER BY staff.is_manager DESC, staff.create_time DESC
    </select>

    <!-- 获取门店管理员列表 -->
    <select id="getManagersByStoreId" resultType="com.zbkj.common.model.merchant.MerchantStoreStaff">
        SELECT 
            staff.*,
            store.store_name as storeName
        FROM eb_merchant_store_staff staff
        LEFT JOIN eb_merchant_store store ON staff.store_id = store.id
        WHERE staff.store_id = #{storeId} 
          AND staff.is_manager = 1
          AND staff.status = 1
        ORDER BY staff.create_time DESC
    </select>

    <!-- 检查员工电话是否已存在 -->
    <select id="checkStaffPhoneExists" resultType="int">
        SELECT COUNT(*) FROM eb_merchant_store_staff 
        WHERE staff_phone = #{staffPhone}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 获取门店员工统计 -->
    <select id="getStoreStaffStatistics" resultType="map">
        SELECT 
            COUNT(*) as totalStaff,
            SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) as activeStaff,
            SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) as inactiveStaff,
            SUM(CASE WHEN is_manager = 1 THEN 1 ELSE 0 END) as managerCount,
            SUM(CASE WHEN is_manager = 0 THEN 1 ELSE 0 END) as staffCount
        FROM eb_merchant_store_staff 
        WHERE store_id = #{storeId}
    </select>

    <!-- 批量更新员工状态 -->
    <update id="batchUpdateStatus">
        UPDATE eb_merchant_store_staff 
        SET status = #{status}, update_time = NOW()
        WHERE id IN 
        <foreach collection="staffIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 根据门店ID删除员工 -->
    <delete id="deleteByStoreId">
        DELETE FROM eb_merchant_store_staff WHERE store_id = #{storeId}
    </delete>

</mapper> 