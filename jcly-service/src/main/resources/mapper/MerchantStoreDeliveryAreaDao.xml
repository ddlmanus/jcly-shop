<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zbkj.service.dao.MerchantStoreDeliveryAreaDao">

    <!-- 根据门店ID获取配送范围列表 -->
    <select id="getByStoreId" resultType="com.zbkj.common.model.merchant.MerchantStoreDeliveryArea">
        SELECT 
            area.*,
            store.store_name as storeName
        FROM eb_merchant_store_delivery_area area
        LEFT JOIN eb_merchant_store store ON area.store_id = store.id
        WHERE area.store_id = #{storeId} 
        ORDER BY area.create_time DESC
    </select>

    <!-- 根据位置查找可配送的门店 -->
    <select id="getDeliveryStoresByLocation" resultType="Integer">
        SELECT DISTINCT area.store_id
        FROM eb_merchant_store_delivery_area area
        INNER JOIN eb_merchant_store store ON area.store_id = store.id
        WHERE area.is_enabled = 1 
          AND store.status = 1
          AND (
              (area.area_type = 'CIRCLE' 
               AND area.center_latitude IS NOT NULL 
               AND area.center_longitude IS NOT NULL 
               AND area.radius IS NOT NULL
               AND (6371 * acos(cos(radians(#{latitude})) * cos(radians(area.center_latitude)) * 
                    cos(radians(area.center_longitude) - radians(#{longitude})) + 
                    sin(radians(#{latitude})) * sin(radians(area.center_latitude)))) &lt;= area.radius)
              OR 
              (area.area_type = 'POLYGON' 
               AND area.polygon_points IS NOT NULL
               -- 多边形判断需要复杂的几何计算，这里简化处理
               AND area.polygon_points != ''
              )
          )
    </select>

    <!-- 检查指定位置是否在配送范围内 -->
    <select id="checkLocationInDeliveryArea" resultType="com.zbkj.common.model.merchant.MerchantStoreDeliveryArea">
        SELECT area.*
        FROM eb_merchant_store_delivery_area area
        WHERE area.store_id = #{storeId}
          AND area.is_enabled = 1
          AND (
              (area.area_type = 'CIRCLE' 
               AND area.center_latitude IS NOT NULL 
               AND area.center_longitude IS NOT NULL 
               AND area.radius IS NOT NULL
               AND (6371 * acos(cos(radians(#{latitude})) * cos(radians(area.center_latitude)) * 
                    cos(radians(area.center_longitude) - radians(#{longitude})) + 
                    sin(radians(#{latitude})) * sin(radians(area.center_latitude)))) &lt;= area.radius)
              OR 
              (area.area_type = 'POLYGON' 
               AND area.polygon_points IS NOT NULL
               -- 多边形判断需要复杂的几何计算，这里简化处理
               AND area.polygon_points != ''
              )
          )
        ORDER BY area.delivery_fee ASC
        LIMIT 1
    </select>

    <!-- 计算配送费用 -->
    <select id="calculateDeliveryFee" resultType="map">
        SELECT 
            area.delivery_fee,
            area.free_delivery_amount,
            area.area_name,
            CASE 
                WHEN #{orderAmount} >= COALESCE(area.free_delivery_amount, 0) THEN 0
                ELSE COALESCE(area.delivery_fee, 0)
            END as finalDeliveryFee
        FROM eb_merchant_store_delivery_area area
        WHERE area.store_id = #{storeId}
          AND area.is_enabled = 1
          AND (
              (area.area_type = 'CIRCLE' 
               AND area.center_latitude IS NOT NULL 
               AND area.center_longitude IS NOT NULL 
               AND area.radius IS NOT NULL
               AND (6371 * acos(cos(radians(#{latitude})) * cos(radians(area.center_latitude)) * 
                    cos(radians(area.center_longitude) - radians(#{longitude})) + 
                    sin(radians(#{latitude})) * sin(radians(area.center_latitude)))) &lt;= area.radius)
              OR 
              (area.area_type = 'POLYGON' 
               AND area.polygon_points IS NOT NULL
               AND area.polygon_points != ''
              )
          )
        ORDER BY area.delivery_fee ASC
        LIMIT 1
    </select>

    <!-- 获取门店配送范围统计 -->
    <select id="getDeliveryAreaStatistics" resultType="map">
        SELECT 
            COUNT(*) as totalAreas,
            SUM(CASE WHEN is_enabled = 1 THEN 1 ELSE 0 END) as enabledAreas,
            SUM(CASE WHEN is_enabled = 0 THEN 1 ELSE 0 END) as disabledAreas,
            SUM(CASE WHEN area_type = 'CIRCLE' THEN 1 ELSE 0 END) as circleAreas,
            SUM(CASE WHEN area_type = 'POLYGON' THEN 1 ELSE 0 END) as polygonAreas,
            AVG(delivery_fee) as avgDeliveryFee,
            MIN(delivery_fee) as minDeliveryFee,
            MAX(delivery_fee) as maxDeliveryFee
        FROM eb_merchant_store_delivery_area 
        WHERE store_id = #{storeId}
    </select>

    <!-- 批量更新配送范围状态 -->
    <update id="batchUpdateStatus">
        UPDATE eb_merchant_store_delivery_area 
        SET is_enabled = #{isEnabled}, update_time = NOW()
        WHERE id IN 
        <foreach collection="areaIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 根据门店ID删除配送范围 -->
    <delete id="deleteByStoreId">
        DELETE FROM eb_merchant_store_delivery_area WHERE store_id = #{storeId}
    </delete>

    <!-- 获取指定商户的所有配送范围 -->
    <select id="getByMerId" resultType="com.zbkj.common.model.merchant.MerchantStoreDeliveryArea">
        SELECT 
            area.*,
            store.store_name as storeName
        FROM eb_merchant_store_delivery_area area
        INNER JOIN eb_merchant_store store ON area.store_id = store.id
        WHERE store.mer_id = #{merId} 
        ORDER BY area.create_time DESC
    </select>

</mapper> 