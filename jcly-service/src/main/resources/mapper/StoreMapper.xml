<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zbkj.service.dao.StoreDao">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.zbkj.common.model.platform.Store">
        <id column="id" property="id"/>
        <result column="mer_id" property="merId"/>
        <result column="store_code" property="storeCode"/>
        <result column="store_name" property="storeName"/>
        <result column="store_type" property="storeType"/>
        <result column="contact_person" property="contactPerson"/>
        <result column="contact_phone" property="contactPhone"/>
        <result column="contact_email" property="contactEmail"/>
        <result column="province" property="province"/>
        <result column="city" property="city"/>
        <result column="district" property="district"/>
        <result column="address_detail" property="addressDetail"/>
        <result column="full_address" property="fullAddress"/>
        <result column="latitude" property="latitude"/>
        <result column="longitude" property="longitude"/>
        <result column="business_hours_start" property="businessHoursStart"/>
        <result column="business_hours_end" property="businessHoursEnd"/>
        <result column="business_days" property="businessDays"/>
        <result column="status" property="status"/>
        <result column="sort" property="sort"/>
        <result column="description" property="description"/>
        <result column="images" property="images"/>
        <result column="tags" property="tags"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_user_id" property="createUserId"/>
        <result column="update_user_id" property="updateUserId"/>
    </resultMap>

    <!-- 带商户名称的结果映射 -->
    <resultMap id="StoreWithMerchantMap" type="com.zbkj.common.model.platform.Store" extends="BaseResultMap">
        <result column="merchant_name" property="merchantName"/>
    </resultMap>

    <!-- 获取门店列表（带商户名称） -->
    <select id="getStoreListWithMerchant" resultMap="StoreWithMerchantMap">
        SELECT s.*, m.mer_name as merchant_name
        FROM eb_platform_store s
        LEFT JOIN eb_merchant m ON s.mer_id = m.id
        <where>
            <if test="params.merId != null">
                AND s.mer_id = #{params.merId}
            </if>
            <if test="params.storeCode != null and params.storeCode != ''">
                AND s.store_code LIKE CONCAT('%', #{params.storeCode}, '%')
            </if>
            <if test="params.storeName != null and params.storeName != ''">
                AND s.store_name LIKE CONCAT('%', #{params.storeName}, '%')
            </if>
            <if test="params.storeType != null and params.storeType != ''">
                AND s.store_type = #{params.storeType}
            </if>
            <if test="params.contactPerson != null and params.contactPerson != ''">
                AND s.contact_person LIKE CONCAT('%', #{params.contactPerson}, '%')
            </if>
            <if test="params.contactPhone != null and params.contactPhone != ''">
                AND s.contact_phone LIKE CONCAT('%', #{params.contactPhone}, '%')
            </if>
            <if test="params.province != null and params.province != ''">
                AND s.province = #{params.province}
            </if>
            <if test="params.city != null and params.city != ''">
                AND s.city = #{params.city}
            </if>
            <if test="params.district != null and params.district != ''">
                AND s.district = #{params.district}
            </if>
            <if test="params.status != null">
                AND s.status = #{params.status}
            </if>
            <if test="params.keyword != null and params.keyword != ''">
                AND (
                    s.store_name LIKE CONCAT('%', #{params.keyword}, '%')
                    OR s.contact_person LIKE CONCAT('%', #{params.keyword}, '%')
                    OR s.contact_phone LIKE CONCAT('%', #{params.keyword}, '%')
                    OR s.full_address LIKE CONCAT('%', #{params.keyword}, '%')
                )
            </if>
            <if test="params.merchantName != null and params.merchantName != ''">
                AND m.mer_name LIKE CONCAT('%', #{params.merchantName}, '%')
            </if>
            <if test="params.startTime != null and params.startTime != ''">
                AND s.create_time >= #{params.startTime}
            </if>
            <if test="params.endTime != null and params.endTime != ''">
                AND s.create_time &lt;= #{params.endTime}
            </if>
        </where>
        <if test="params.orderBy != null and params.orderBy != ''">
            <choose>
                <when test="params.orderDirection == 'asc'">
                    ORDER BY s.${params.orderBy} ASC
                </when>
                <otherwise>
                    ORDER BY s.${params.orderBy} DESC
                </otherwise>
            </choose>
        </if>
        <if test="params.orderBy == null or params.orderBy == ''">
            ORDER BY s.sort DESC, s.id DESC
        </if>
    </select>

    <!-- 根据商户ID获取门店列表 -->
    <select id="getStoreListByMerId" resultMap="BaseResultMap">
        SELECT *
        FROM eb_platform_store
        WHERE mer_id = #{merId}
        ORDER BY sort DESC, id DESC
    </select>

    <!-- 根据位置查找附近的门店 -->
    <select id="getNearbyStores" resultMap="BaseResultMap">
        SELECT *,
               (
                   6371 * acos(
                       cos(radians(#{latitude})) * cos(radians(latitude)) * cos(radians(longitude) - radians(#{longitude}))
                       + sin(radians(#{latitude})) * sin(radians(latitude))
                   )
               ) AS distance
        FROM eb_platform_store
        WHERE status = 1 
          AND latitude IS NOT NULL 
          AND longitude IS NOT NULL
          AND (
                   6371 * acos(
                       cos(radians(#{latitude})) * cos(radians(latitude)) * cos(radians(longitude) - radians(#{longitude}))
                       + sin(radians(#{latitude})) * sin(radians(latitude))
                   )
               ) &lt; #{radius}
        ORDER BY (
                   6371 * acos(
                       cos(radians(#{latitude})) * cos(radians(latitude)) * cos(radians(longitude) - radians(#{longitude}))
                       + sin(radians(#{latitude})) * sin(radians(latitude))
                   )
               ) ASC
        LIMIT #{limit}
    </select>

    <!-- 获取门店统计信息 -->
    <select id="getStoreStatistics" resultType="java.util.Map">
        SELECT COUNT(*) as total_orders,
               IFNULL(SUM(o.pay_price), 0) as total_sales,
               MAX(o.create_time) as last_order_time
        FROM eb_order o
        WHERE o.store_id = #{storeId}
          AND o.paid = 1
          AND o.refund_status = 0
    </select>

    <!-- 批量更新门店状态 -->
    <update id="batchUpdateStatus">
        UPDATE eb_platform_store
        SET status = #{status}
        WHERE id IN
        <foreach collection="storeIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 检查门店编码是否已存在 -->
    <select id="checkStoreCodeExists" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM eb_platform_store
        WHERE store_code = #{storeCode}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

</mapper>